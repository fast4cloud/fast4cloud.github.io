<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>雪花算法组件</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.700ad5ea.css" as="style"><link rel="preload" href="/assets/js/app.0ed563b7.js" as="script"><link rel="preload" href="/assets/js/2.354ad097.js" as="script"><link rel="preload" href="/assets/js/22.57940240.js" as="script"><link rel="prefetch" href="/assets/js/10.02bd5496.js"><link rel="prefetch" href="/assets/js/11.0bef0208.js"><link rel="prefetch" href="/assets/js/12.a91a1955.js"><link rel="prefetch" href="/assets/js/13.4beec80a.js"><link rel="prefetch" href="/assets/js/14.f5f78963.js"><link rel="prefetch" href="/assets/js/15.3d577d31.js"><link rel="prefetch" href="/assets/js/16.ec008f72.js"><link rel="prefetch" href="/assets/js/17.89d3bd1d.js"><link rel="prefetch" href="/assets/js/18.5b8ccaa5.js"><link rel="prefetch" href="/assets/js/19.3ca70ef6.js"><link rel="prefetch" href="/assets/js/20.011d3d78.js"><link rel="prefetch" href="/assets/js/21.9ef57bdb.js"><link rel="prefetch" href="/assets/js/3.f3d286f5.js"><link rel="prefetch" href="/assets/js/4.bf9cbb42.js"><link rel="prefetch" href="/assets/js/5.58ae779b.js"><link rel="prefetch" href="/assets/js/6.d535432a.js"><link rel="prefetch" href="/assets/js/7.59adb44c.js"><link rel="prefetch" href="/assets/js/8.1faa2eb4.js"><link rel="prefetch" href="/assets/js/9.ab4f4613.js">
    <link rel="stylesheet" href="/assets/css/0.styles.700ad5ea.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/fast4cloud/fast4cloud.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  指南
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/fast4cloud/fast4cloud.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  指南
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开始指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>组件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/component/common-core.html" class="sidebar-link">工具包</a></li><li><a href="/component/adviceException.html" class="sidebar-link">全局异常组件</a></li><li><a href="/component/captcha.html" class="sidebar-link">验证码</a></li><li><a href="/component/dynamic-data-source.html" class="sidebar-link">动态多数据源</a></li><li><a href="/component/log-aspect.html" class="sidebar-link">日志切面记录</a></li><li><a href="/component/logger.html" class="sidebar-link">自定义日志组件</a></li><li><a href="/component/redis.html" class="sidebar-link">redis组件</a></li><li><a href="/component/security.html" class="sidebar-link">安全认证组件</a></li><li><a href="/component/snowfrake-id.html" aria-current="page" class="active sidebar-link">雪花算法组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#引入maven-包" class="sidebar-link">引入maven 包</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#当前使用算法包版本" class="sidebar-link">当前使用算法包版本</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#在yml-配置信息如下" class="sidebar-link">在yml 配置信息如下</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#实际使用" class="sidebar-link">实际使用</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#技术支持" class="sidebar-link">技术支持</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#💎-算法介绍" class="sidebar-link">💎 算法介绍</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#💎-id组成说明" class="sidebar-link">💎 ID组成说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#长度估算" class="sidebar-link">长度估算</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#能用多久" class="sidebar-link">能用多久</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#补充说明" class="sidebar-link">补充说明</a></li></ul></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#💎-参数设置" class="sidebar-link">💎 参数设置</a></li><li class="sidebar-sub-header"><a href="/component/snowfrake-id.html#自动注册workerid" class="sidebar-link">自动注册WorkerId</a></li></ul></li><li><a href="/component/swagger.html" class="sidebar-link">swagger组件</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="雪花算法组件"><a href="#雪花算法组件" class="header-anchor">#</a> 雪花算法组件</h1> <h2 id="引入maven-包"><a href="#引入maven-包" class="header-anchor">#</a> 引入maven 包</h2> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fast4cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>framework-starter-snowfrake-id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="当前使用算法包版本"><a href="#当前使用算法包版本" class="header-anchor">#</a> 当前使用算法包版本</h2> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token comment">&lt;!--雪花算法包--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.yitter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>yitter-idgenerator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="在yml-配置信息如下"><a href="#在yml-配置信息如下" class="header-anchor">#</a> 在yml 配置信息如下</h2> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 自定义配置</span>
<span class="token key atrule">self</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
   <span class="token comment">#雪花算法</span>
    <span class="token key atrule">yitter</span><span class="token punctuation">:</span>
      <span class="token comment"># 表示使用什么算法，默认值为1，表示使用雪花漂移算法，2表示使用传统雪花算法。但仍建议你使用雪花漂移算法（Method=1，默认的），毕竟它具有更好的伸缩力和更高的性能。</span>
      <span class="token key atrule">method</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token comment"># 基础时间（也称：基点时间、原点时间、纪元时间），默认值为：2022-01-01 00:00:00，是毫秒时间戳（是整数，.NET是DatetTime类型），作用是：用生成ID时的系统时间与基础时间的差值（毫秒数）作为生成ID的时间戳。基础时间一般无需设置，如果觉得默认值太老，你可以重新设置，不过要注意，这个值以后最好不变。</span>
      <span class="token key atrule">baseTime</span><span class="token punctuation">:</span> <span class="token number">1640966400000</span>
      <span class="token comment"># 机器码，最重要参数，默认值0，必须 全局唯一（或相同 DataCenterId 内唯一），必须 程序设定，缺省条件（WorkerIdBitLength取默认值）时最大值63，理论最大值 2^WorkerIdBitLength-1（不同实现语言可能会限定在 65535 或 32767，原理同 WorkerIdBitLength 规则）</span>
      <span class="token key atrule">workerId</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token comment"># 机器码位长，决定 WorkerId 的最大值，默认值1，取值范围 [1, 19]，实际上有些语言采用 无符号 ushort (uint16) 类型接收该参数，所以最大值是16，如果是采用 有符号 short (int16)，则最大值为15。</span>
      <span class="token key atrule">workerIdBitLength</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token comment"># 序列数位长，默认值6，取值范围 [3, 21]（建议不小于4），决定每毫秒基础生成的ID个数。规则要求：WorkerIdBitLength + SeqBitLength 不超过 22。</span>
      <span class="token key atrule">seqBitLength</span><span class="token punctuation">:</span> <span class="token number">6</span>
      <span class="token comment"># 最小序列数，默认值5，取值范围 [5, MaxSeqNumber]，每毫秒的前5个序列数对应编号0-4是保留位，其中0是手工插入新值预留位，1-4是时间回拨相应预留位。</span>
      <span class="token key atrule">minSeqNumber</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token comment"># 最大序列数，设置范围 [MinSeqNumber, 2^SeqBitLength-1]，默认值0，真实最大序列数取最大值（2^SeqBitLength-1），不为0时，取其为真实最大序列数，一般无需设置，除非多机共享WorkerId分段生成ID（此时还要正确设置最小序列数）。</span>
      <span class="token key atrule">maxSeqNumber</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token comment"># 最大漂移次数，与计算能力有关</span>
      <span class="token key atrule">topOverCostCount</span><span class="token punctuation">:</span> <span class="token number">2000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="实际使用"><a href="#实际使用" class="header-anchor">#</a> 实际使用</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token comment">// 初始化以后，即可在任何需要生成ID的地方，调用以下方法：</span>
<span class="token keyword">long</span> newId <span class="token operator">=</span> <span class="token class-name">FdSnowFrakeIdUtil</span><span class="token punctuation">.</span><span class="token function">getLongId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> newId <span class="token operator">=</span> <span class="token class-name">FdSnowFrakeIdUtil</span><span class="token punctuation">.</span><span class="token function">getStrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>│ ├─config                   配置目录
│ |  ├─SnowFrakeConfig       初始化配置
| |  └─SnowFrakeProperties   自定义properties配置+
| └─utils                    工具类
|    └─FdSnowFrakeIdUtil     实际使用工具类
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><em><strong>引用</strong></em></p> <h2 id="技术支持"><a href="#技术支持" class="header-anchor">#</a> 技术支持</h2> <p>开源地址：https://github.com/yitter/IdGenerator</p> <p>QQ群：646049993</p> <h2 id="💎-算法介绍"><a href="#💎-算法介绍" class="header-anchor">#</a> 💎 算法介绍</h2> <p>❄ 这是优化的雪花算法（雪花漂移），它生成的ID更短、速度更快。</p> <p>❄ 支持 k8s 等容器环境自动扩容（自动注册 WorkerId），可在单机或分布式环境生成数字型唯一ID。</p> <p>❄ 原生支持 C#/Java/Go/Rust/C/SQL/Node.js/PHP(C扩展) 等语言，并提供Python、PB多线程安全调用动态库（FFI）。</p> <p>❄ 兼容所有雪花算法（号段模式或经典模式，大厂或小厂），将来你可做任意的升级切换。（一般无须升级，但理论上支持）</p> <p>❄ 这是计算机历史上最全面的雪花ID生成工具。</p> <h4 id="需求来源"><a href="#需求来源" class="header-anchor">#</a> 需求来源</h4> <p>💧 作为架构设计的你，想要解决数据库主键唯一的问题，特别是在分布式系统多数据库中。</p> <p>💧 你希望数据表主键用最少的存储空间，索引速度更快，Select、Insert 和 Update 更迅速。</p> <p>💧 你要考虑在分库分表（合库合表）时，主键值可直接使用，并能反映业务时序。</p> <p>💧 如果这样的主键值太长，超过前端 js Number 类型最大值，须把 Long 型转换为 String 型，你会觉得有点沮丧。</p> <p>💧 尽管 Guid 能自增，但占用空间大，索引速度慢，你不想用它。</p> <p>💧 应用实例可能超过50个，每个并发请求可达10W/s。</p> <p>💧 要在容器环境部署应用，支持水平复制、自动扩容。</p> <p>💧 不想依赖 redis 的自增操作获得连续的主键ID，因为连续的ID存在业务数据安全风险。</p> <p>💧 你希望系统运行 100 年以上。</p> <h4 id="传统算法问题"><a href="#传统算法问题" class="header-anchor">#</a> 传统算法问题</h4> <p>❌ 生成的ID太长。</p> <p>❌ 瞬时并发量不够。</p> <p>❌ 不能解决时间回拨问题。</p> <p>❌ 不支持后补生成前序ID。</p> <p>❌ 可能依赖外部存储系统。</p> <h4 id="新算法特点"><a href="#新算法特点" class="header-anchor">#</a> 新算法特点</h4> <p>✔ 整形数字，随时间单调递增（不一定连续），长度更短，用50年都不会超过 js Number类型最大值。（默认配置）</p> <p>✔ 速度更快，是传统雪花算法的2-5倍，0.1秒可生成50万个（基于8代低压i7）。</p> <p>✔ 支持时间回拨处理。比如服务器时间回拨1秒，本算法能自动适应生成临界时间的唯一ID。</p> <p>✔ 支持手工插入新ID。当业务需要在历史时间生成新ID时，用本算法的预留位能生成5000个每秒。</p> <p>✔ 不依赖任何外部缓存和数据库。（k8s环境下自动注册 WorkerId 的动态库依赖 redis）</p> <p>✔ 基础功能，开箱即用，无需配置文件、数据库连接等。</p> <h4 id="性能数据"><a href="#性能数据" class="header-anchor">#</a> 性能数据</h4> <p>(参数：10位自增序列，1000次漂移最大值)</p> <table><thead><tr><th>连续请求量</th> <th>5K</th> <th>5W</th> <th>50W</th></tr></thead> <tbody><tr><td>传统雪花算法</td> <td>0.0045s</td> <td>0.053s</td> <td>0.556s</td></tr> <tr><td>雪花漂移算法</td> <td>0.0015s</td> <td>0.012s</td> <td>0.113s</td></tr></tbody></table> <p>💍 极致性能：500W/s~3000W/s。（所有测试数据均基于8代低压i7计算）</p> <h4 id="如何处理时间回拨"><a href="#如何处理时间回拨" class="header-anchor">#</a> 如何处理时间回拨</h4> <p>🔶 当发生系统时间回拨时，算法采用过去时序的预留序数生成新的ID。</p> <p>🔶 回拨生成的ID序号，默认靠前，也可以调整为靠后。</p> <p>🔶 允许时间回拨至本算法预设基数（参数可调）。</p> <h2 id="💎-id组成说明"><a href="#💎-id组成说明" class="header-anchor">#</a> 💎 ID组成说明</h2> <ul><li>本算法生成的ID由3部分组成（沿用雪花算法定义）：</li> <li>+-------------------------+--------------+----------+</li> <li>| 1.相对基础时间的时间差 | 2.WorkerId | 3.序列数 |</li> <li>+-------------------------+--------------+----------+</li> <li></li> <li>第1部分，时间差，是生成ID时的系统时间减去 BaseTime 的总时间差（毫秒单位）。</li> <li>第2部分，WorkerId，是区分不同机器或不同应用的唯一ID，最大值由 WorkerIdBitLength（默认6）限定。</li> <li>第3部分，序列数，是每毫秒下的序列数，由参数中的 SeqBitLength（默认6）限定。</li></ul> <h4 id="id示例"><a href="#id示例" class="header-anchor">#</a> ID示例</h4> <p>🟣 本算法生成的 ID ，是整数（占用空间最多8字节），以下是基于默认配置生成的ID：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>129053495681099        (运行1年)
387750301904971        (运行3年)
646093214093387        (运行5年)
1292658282840139       (运行10年)
9007199254740992       (js Number 最大值，可以支撑70年)
165399880288699493     (普通雪花算法生成的ID)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>🟣 本算法生成的 ID 值，是 js Number 最大值的 1%-10%，是普通雪花算法值的千分之一，而生成速度却超过普通雪花算法。</p> <p>🟣 js Number 类型最大数值：9007199254740992，本算法在保持并发性能（5W+/0.01s）和最大64个 WorkerId（6bit）的同时，能用70年才到 js Number Max 值。</p> <h3 id="长度估算"><a href="#长度估算" class="header-anchor">#</a> 长度估算</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>💍 每增加 1位 WorkerIdBitLength 或 SeqBitLength，生成的ID数字值将会乘以2（基础长度可参考前一节“ID示例”），反之则除以2。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="能用多久"><a href="#能用多久" class="header-anchor">#</a> 能用多久</h3> <p>能用多久的解释，是指生成的ID数字，何时能增长到超过 long（有符号64位，8字节）最大值。</p> <p>🔵 在默认配置下，ID可用 71000 年不重复。</p> <p>🔵 在支持 1024 个工作节点时，ID可用 4480 年不重复。</p> <p>🔵 在支持 4096 个工作节点时，ID可用 1120 年不重复。</p> <h3 id="补充说明"><a href="#补充说明" class="header-anchor">#</a> 补充说明</h3> <p>❄ 默认算法，每个时间戳开始，生成的ID是奇数。</p> <p>❄ 可以把ID右移 WorkerIdBitLength+SeqBitLength，得到时间戳。</p> <h2 id="💎-参数设置"><a href="#💎-参数设置" class="header-anchor">#</a> 💎 参数设置</h2> <p>❄ <em><strong>WorkerIdBitLength</strong></em>，机器码位长，决定 WorkerId 的最大值，<strong>默认值6</strong>，取值范围 [1, 19]，实际上有些语言采用 无符号 ushort (uint16)
类型接收该参数，所以最大值是16，如果是采用 有符号 short (int16)，则最大值为15。</p> <p>❄ <strong>WorkerId</strong>，机器码，<strong>最重要参数</strong>，无默认值，必须 <strong>全局唯一</strong>（或相同 DataCenterId 内唯一），必须 <strong>程序设定</strong>，缺省条件（WorkerIdBitLength取默认值）时最大值63，理论最大值
2^WorkerIdBitLength-1（不同实现语言可能会限定在 65535 或 32767，原理同 WorkerIdBitLength 规则）。不同机器或不同应用实例 <strong>不能相同</strong>
，你可通过应用程序配置该值，也可通过调用外部服务获取值。针对自动注册WorkerId需求，本算法提供默认实现：通过 redis 自动注册 WorkerId 的动态库，详见“Tools\AutoRegisterWorkerId”。</p> <p><strong>特别提示</strong>：如果一台服务器部署多个独立服务，需要为每个服务指定不同的 WorkerId。</p> <p>❄ <em><strong>SeqBitLength</strong></em>，序列数位长，<strong>默认值6</strong>，取值范围 [3, 21]（建议不小于4），决定每毫秒基础生成的ID个数。规则要求：WorkerIdBitLength + SeqBitLength 不超过 22。</p> <p>❄ <em><strong>MinSeqNumber</strong></em>，最小序列数，默认值5，取值范围 [5, MaxSeqNumber]，每毫秒的前5个序列数对应编号0-4是保留位，其中1-4是时间回拨相应预留位，0是手工新值预留位。</p> <p>❄ <em><strong>MaxSeqNumber</strong></em>，最大序列数，设置范围 [MinSeqNumber, 2^SeqBitLength-1]
，默认值0，真实最大序列数取最大值（2^SeqBitLength-1），不为0时，取其为真实最大序列数，一般无需设置，除非多机共享WorkerId分段生成ID（此时还要正确设置最小序列数）。</p> <p>❄ <em><strong>BaseTime</strong></em>
，基础时间（也称：基点时间、原点时间、纪元时间），有默认值（2020年），是毫秒时间戳（是整数，.NET是DatetTime类型），作用是：用生成ID时的系统时间与基础时间的差值（毫秒数）作为生成ID的时间戳。基础时间一般无需设置，如果觉得默认值太老，你可以重新设置，不过要注意，这个值以后最好不变。</p> <p>第二版增加参数（非必须）：</p> <p>❄ <em><strong>DataCenterId</strong></em>，数据中心ID（机房ID，默认0），请确保全局唯一。</p> <p>❄ <em><strong>DataCenterIdBitLength</strong></em>，数据中心ID长度（默认0）。</p> <p>❄ <em><strong>TimestampType</strong></em>，时间戳类型（0-毫秒，1-秒），默认0。</p> <h4 id="常规集成"><a href="#常规集成" class="header-anchor">#</a> 常规集成</h4> <p>1️⃣ 用单例模式调用。外部集成方使用更多的实例并行调用本算法，不会增加ID产出效能，因为本算法采用单线程生成ID。</p> <p>2️⃣ 指定唯一的 WorkerId。必须由外部系统确保 WorkerId 的全局唯一性，并赋值给本算法入口方法。</p> <p>3️⃣ 单机多实例部署时使用不同 WorkerId。并非所有实现都支持跨进程的并发唯一，保险起见，在同一主机上部署多应用实例时，请确保各 WorkerId 唯一。</p> <p>4️⃣ 异常处理。算法会抛出所有 Exception，外部系统应 catch 异常并做好应对处理，以免引发更大的系统崩溃。</p> <p>5️⃣ 认真理解 IdGeneratorOptions 的定义，这对集成和使用本算法有帮助。</p> <p>6️⃣ 使用雪花漂移算法。虽然代码里包含了传统雪花算法的定义，并且你可以在入口处指定（Method=2）来启用传统算法，但仍建议你使用雪花漂移算法（Method=1，默认的），毕竟它具有更好的伸缩力和更高的性能。</p> <p>7️⃣ 不要修改核心算法。本算法内部参数较多，逻辑较为复杂，在你尚未掌握核心逻辑时，请勿修改核心代码且用于生产环境，除非通过大量细致、科学的测试验证。</p> <p>8️⃣ 应用域内配置策略相同。当系统运行一段时间后，项目需要从程序指定 WorkerId 转到自动注册 WorkerId 时，请确保同一应用域内所有在用实例采用一致的配置策略，这不仅仅针对 WorkerId，也包含其他所有配置参数。</p> <p>9️⃣ 管理好服务器时间。雪花算法依赖系统时间，不要手工大幅度回调操作系统时间。如果一定要调整，切记：确保服务再次启动时的系统时间大于最后一次关闭时的时间。（注：世界级或网络级的时间同步或回拨，引起的系统时间小幅度变化，对本算法没影响）</p> <h4 id="配置变更"><a href="#配置变更" class="header-anchor">#</a> 配置变更</h4> <p>配置变更指是系统运行一段时间后，再调整运行参数（IdGeneratorOptions 选项值），请注意：</p> <p>🔴 1.最重要的一条原则是：BaseTime <strong>只能往前</strong>（比老值更小、距离现在更远）赋值，原因是往后赋值极大可能产生相同的时间戳。[<strong>不推荐</strong>在系统运行之后调整 BaseTime]</p> <p>🔴 2.任何时候增加 WorkerIdBitLength 或 SeqBitLength，都是可以的，但是慎用 “减小”的操作，因为这可能导致在未来某天生成的 ID 与过去老配置时相同。[允许在系统运行之后**
增加**任何一个 BitLength 值]</p> <p>🔴 3.如果必须减小 WorkerIdBitLength 或 SeqBitLength 其中的一项，一定要满足一个条件：新的两个 BitLength 之和要大于 老的值之和。[<strong>不推荐</strong>在运行之后缩小任何一个 BitLength 值]</p> <p>🔴 4.上述3条规则，并未在本算法内做逻辑控制，集成方应根据上述规则做好影响评估，确认无误后，再实施配置变更。</p> <h2 id="自动注册workerid"><a href="#自动注册workerid" class="header-anchor">#</a> 自动注册WorkerId</h2> <p>🔍 唯一ID生成器，依赖WorkerId，当业务服务需要水平无差别复制（自动扩容）时，这就要求能自动注册全局唯一WorkerId，然后才能生产唯一ID。</p> <p>🔍 本算法提供开源动态库（go语言实现），能在容器 k8s 等容器环境下，通过 redis 自动注册 WorkerId。</p> <p>🔍 通过redis注册WorkerId，并非唯一方法。你还可以开发中心化的配置服务，各端点服务启动时，通过中心服务获取唯一 WorkerId。</p> <p>🔍 当然，如果你的服务无需自动扩容，那就不必自动注册WorkerId，而是为它们分别设置全局唯一值。</p> <p>🔍 方法还有很多，例如：开发中心化的ID生成服务，由它为各端点服务（单个或批量）生成可用ID。</p> <h4 id="自动注册流程图"><a href="#自动注册流程图" class="header-anchor">#</a> 自动注册流程图</h4> <p>图片链接：https://github.com/yitter/IdGenerator/blob/master/Tools/AutoRegisterWorkerId/regprocess.jpg</p> <p>源码路径：/Go/source/regworkerid/reghelper.go</p> <h4 id="动态库下载"><a href="#动态库下载" class="header-anchor">#</a> 动态库下载</h4> <p>下载链接1：https://github.com/yitter/IdGenerator/releases/download/reg_v1.0/regworkerid_lib_v1.0.zip</p> <p>下载链接2：https://gitee.com/yitter/idgenerator/attach_files/662372/download/regworkerid_lib_v1.0.zip</p> <h4 id="动态库接口定义"><a href="#动态库接口定义" class="header-anchor">#</a> 动态库接口定义</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 注册一个 WorkerId，会先注销所有本机已注册的记录
// ip: redis 服务器地址
// port: redis 端口
// password: redis 访问密码，可为空字符串“”
// maxWorkerId: 最大 WorkerId
extern GoInt32 RegisterOne(char* ip, GoInt32 port, char* password, GoInt32 maxWorkerId);

// 注销本机已注册的 WorkerId
extern void UnRegister();

// 检查本地WorkerId是否有效（0-有效，其它-无效）
extern GoInt32 Validate(GoInt32 workerId);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/1/2023, 10:26:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/component/security.html" class="prev">
        安全认证组件
      </a></span> <span class="next"><a href="/component/swagger.html">
        swagger组件
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0ed563b7.js" defer></script><script src="/assets/js/2.354ad097.js" defer></script><script src="/assets/js/22.57940240.js" defer></script>
  </body>
</html>
